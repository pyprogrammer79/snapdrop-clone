<!DOCTYPE html>
<html lang="de">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Snapdrop Clone</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 40px; }
    #devices {
      margin: 20px;
      display: flex;
      flex-wrap: wrap;       /* mehrere Ger√§te umbrechen */
      justify-content: center; /* horizontal zentrieren */
      gap: 20px;             /* Abstand zwischen Ger√§ten */
    }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .device {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100px;
      height: 120px;
      margin: 15px;
      border-radius: 20px;
      background: #222;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .device:hover {
      transform: scale(1.05);
    }

    .device-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .device-name {
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      color: #fff;
    }

    h1 {
      font-size: 3.25em;
    }

    h3 {
      font-size: 2.25em; 
    }

    /* Nur f√ºr mobile Ger√§te (max. 768px Breite) */
    @media (max-width: 768px) {
      body {
        font-size: 20px; /* Gesamtschrift gr√∂√üer */
      }

      h1 {
        font-size: 1.75em; /* √úberschrift etwas gr√∂√üer */
      }

      h3 {
        font-size: 1em;
      }

      .device {
        width: 80px;   /* K√§stchen gr√∂√üer */
        height: 95px;
      }

      .device-icon {
        width: 45px;   /* Icon gr√∂√üer */
        height: 45px;
        font-size: 31px;
      }

      .device-name {
        font-size: 10px;
      }

      .device:hover {
        transform: scale(1.05);
      }
    }

  </style>
</head>
<body>
  <h1>üìÇ Snapdrop Clone</h1>
  <h3>Verbundene Ger√§te:</h3>
  <div id="devices"></div>

  <input type="file" id="fileInput" multiple hidden>

  <script>
    const ws = new WebSocket(`ws://${location.host}`);
    let selectedTarget = null;
    const devicesDiv = document.getElementById("devices");
    const fileInput = document.getElementById("fileInput");

    // ------------------- GER√ÑTENAME -------------------
    let deviceName = localStorage.getItem("deviceName");
    if (!deviceName) {
      deviceName = prompt("Wie soll dein Ger√§t hei√üen?", "Mein Ger√§t");
      if (!deviceName) deviceName = "Unbekanntes Ger√§t";
      localStorage.setItem("deviceName", deviceName);
    }

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "register", name: deviceName }));
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      // Ger√§teliste aktualisieren
      if (data.type === "clients") {
        devicesDiv.innerHTML = "";
        for (let client of data.clients) {
          if (client.name === deviceName) continue; // eigenes Ger√§t nicht anzeigen

          const card = document.createElement("div");
          card.className = "device";
          card.onclick = () => {
            selectedTarget = client.id;
            fileInput.click();
          };

          const icon = document.createElement("div");
          icon.className = "device-icon";
          icon.innerText = "üì±"; // du kannst hier auch dynamisch √§ndern (Laptop, PC, etc.)

          const name = document.createElement("div");
          name.className = "device-name";
          name.innerText = client.name;

          card.appendChild(icon);
          card.appendChild(name);
          devicesDiv.appendChild(card);
        }
      }

      // Datei-Angebot
      if (data.type === "offer") {
        const accept = confirm(`üì• ${data.filename} von ${data.fromName} annehmen?`);
        ws.send(JSON.stringify({ type: "answer", to: data.from, accept }));
      }

      // Datei empfangen
      if (data.type === "file") {
        const blob = new Blob([new Uint8Array(data.data)], { type: data.mimetype });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = data.filename;
        a.click();
      }
    };

    // Datei ausw√§hlen und senden
    fileInput.addEventListener("change", async () => {
      if (!selectedTarget) return;
      const files = fileInput.files;
      for (const file of files) {
        // Offer senden
        ws.send(JSON.stringify({
          type: "offer",
          to: selectedTarget,
          filename: file.name,
          mimetype: file.type
        }));

        // Antwort abwarten
        const waitAnswer = await new Promise((resolve) => {
          const handler = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "answer" && data.from === selectedTarget) {
              ws.removeEventListener("message", handler);
              resolve(data.accept);
            }
          };
          ws.addEventListener("message", handler);
        });

        if (!waitAnswer) {
          alert("‚ùå Empf√§nger hat abgelehnt.");
          continue;
        }

        // Datei senden
        const arrayBuffer = await file.arrayBuffer();
        ws.send(JSON.stringify({
          type: "file",
          to: selectedTarget,
          filename: file.name,
          mimetype: file.type,
          data: Array.from(new Uint8Array(arrayBuffer))
        }));
      }
      fileInput.value = "";
    });
  </script>
</body>
</html>
